<!DOCTYPE html>
<html lang="fr-FR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Souscription - √âtape 4 : Choix du Lot</title>

    <!-- CSS Files -->
    <link rel='stylesheet' href='../../css/bootstrap.css' type='text/css' media='all' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel='stylesheet' href='../../css/paroti-style.css' type='text/css' media='all' />
    <link rel='stylesheet' href='../../css/custom-flow.css' type='text/css' media='all' />

    <!-- Supabase SDK - Load First! -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- AGEF Database (Cloud) -->
    <script src="../../js/database-supabase.js"></script>

    <style>
        body {
            font-family: 'Manrope', sans-serif;
            background-color: #f9f9f9;
        }

        .header-simple {
            background: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .logo-img {
            max-height: 60px;
        }
    </style>
</head>

<body>

    <!-- Simple Header -->
    <header class="header-simple">
        <div class="container">
            <div class="text-center">
                <a href="../../index.html">
                    <img src="../../images/logo.png" alt="AGEF" class="logo-img">
                </a>
            </div>
        </div>
    </header>

    <div class="container">

        <!-- Breadcrumbs -->
        <div class="flow-breadcrumbs">
            <div class="breadcrumb-step completed">
                <div class="step-circle"><i class="fas fa-check"></i></div>
                <div class="step-label">Localisation</div>
            </div>
            <div class="step-connector completed"></div>
            <div class="breadcrumb-step completed">
                <div class="step-circle"><i class="fas fa-check"></i></div>
                <div class="step-label">Conditions</div>
            </div>
            <div class="step-connector completed"></div>
            <div class="breadcrumb-step completed">
                <div class="step-circle"><i class="fas fa-check"></i></div>
                <div class="step-label">Identit√©</div>
            </div>
            <div class="step-connector completed"></div>
            <div class="breadcrumb-step active">
                <div class="step-circle">4</div>
                <div class="step-label">Lots</div>
            </div>
            <div class="step-connector"></div>
            <div class="breadcrumb-step">
                <div class="step-circle">5</div>
                <div class="step-label">R√©sum√©</div>
            </div>
            <div class="step-connector"></div>
            <div class="breadcrumb-step">
                <div class="step-circle">6</div>
                <div class="step-label">Paiement</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="text-center mb-5">
                    <h2 class="mb-3">Disponibilit√©s √† <span id="locationNameDisplay"></span></h2>
                    <p class="text-muted">S√©lectionnez un lot parmi les disponibilit√©s ci-dessous.</p>
                </div>

                <div class="row" id="lotsGrid">
                    <!-- Lots will be generated by JS -->
                </div>

                <div class="flow-nav">
                    <a href="identite.html" class="btn-back">Retour</a>
                    <!-- Next button hidden until selection -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check prev steps
        if (!sessionStorage.getItem('agef_user_name')) {
            // window.location.href = 'identite.html'; // Commented out for easier testing
        }

        const locationName = sessionStorage.getItem('agef_location_name') || 'Songon';
        document.getElementById('locationNameDisplay').textContent = locationName;

        // Mock Data for Lots
        const lotsData = [
            { id: '401', size: '500', price: '5 000 000' },
            { id: '402', size: '600', price: '6 000 000' },
            { id: '403', size: '500', price: '5 000 000' },
            { id: '404', size: '400', price: '4 000 000' },
            { id: '405', size: '800', price: '8 000 000' },
            { id: '406', size: '500', price: '5 000 000' },
        ];

        const lotsGrid = document.getElementById('lotsGrid');

        lotsData.forEach(lot => {
            const col = document.createElement('div');
            col.className = 'col-md-4 mb-4';
            col.innerHTML = `
                <div class="lot-card" onclick="selectLot('${lot.id}', '${lot.size}', '${lot.price}', this)">
                    <div class="lot-number"><i class="fas fa-map-signs" style="color: #2B8E38; margin-right: 5px;"></i> Lot ${lot.id}</div>
                    <div class="lot-size"><i class="fas fa-ruler-combined" style="color: #666; margin-right: 5px;"></i> ${lot.size} m¬≤</div>
                    <div class="lot-price"><i class="fas fa-tag" style="color: #666; margin-right: 5px;"></i> ${lot.price} FCFA</div>
                    <div class="mt-3 btn btn-sm btn-outline-success">S√©lectionner</div>
                </div>
            `;
            lotsGrid.appendChild(col);
        });

        async function selectLot(id, size, price, element) {
            // Visual selection
            document.querySelectorAll('.lot-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');

            // Save to sessionStorage
            sessionStorage.setItem('agef_lot_id', id);
            sessionStorage.setItem('agef_lot_size', size);
            sessionStorage.setItem('agef_lot_price', price);

            // Update database record with lot selection
            try {
                const clientId = sessionStorage.getItem('agef_client_id');
                if (clientId) {
                    console.log('üíæ Updating client record with lot selection...');
                    await AGEFDatabase.updateClient(parseInt(clientId), {
                        parcel_ref: `Lot ${id}`,
                        parcel_area: `${size} m¬≤`
                    });
                    console.log('‚úÖ Lot selection saved');
                } else {
                    console.warn('‚ö†Ô∏è No client ID found in session. Skipping database update.');
                }
            } catch (error) {
                console.error('‚ùå Error updating lot:', error);
                // Don't block the flow if update fails
            }

            // Redirect
            setTimeout(() => {
                window.location.href = 'resume.html';
            }, 300);
        }
    </script>
</body>

</html>